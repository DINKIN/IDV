<?xml version="1.0" encoding="UTF-8"?>


<project basedir="../../../" default="all" name="Ramadda">


    <target name="init">
       <tstamp>
         <format property="date" pattern="yyyy-MM-dd HH:mm z" timezone="UTC"/>
       </tstamp>
        <property  name="version" value="1.1"/>
        <property  name="build.sysclasspath" value="ignore"/>
        <property name="srcdir" value="${basedir}"/>
        <property name="failonerror" value="true"/>
        <property name="compiledir" value="${srcdir}"/>
        <property name="srcversion" value="1.5"/>
        <property name="jars_dest" value="${basedir}/lib"/>
        <property name="libsrc" value="${basedir}/libsrc"/>
        <property name="libsdir" value="${jars_dest}"/>
        <property name="repositorydir" value="${srcdir}/ucar/unidata/repository" />
        <property name="releasedir" value="${libsdir}/repository" />
        <property name="tmpjardir" value="${libsdir}/tmpjardir" />

	<property name="docs_dest" value="${basedir}/repositorydocs"/>
        <mkdir dir="${docs_dest}"/>
        <property name="docs_javadoc_dest" value="${docs_dest}/javadoc" />
        <mkdir dir="${docs_javadoc_dest}"/>

       <property name="classpath" value="${libsdir}/idv.jar:${libsdir}/repositorylib.jar:${libsdir}/repositorytds.jar:${libsdir}/servlet-api.jar"/>
    </target>

    <target name="clean" depends="init" >
        <delete>
            <fileset dir="${compiledir}/ucar" includes="**/*.class"/>
        </delete>
    </target>

    <target name="runserver" depends="init">
      <java classname="ucar.unidata.repository.RepositoryServer" maxmemory="512mb">
          <arg value="-port"/>
          <arg value="8080"/>
          <arg value="-Dramadda.db=mysql"/>
          <arg value="-Dramadda.cacheresources=false"/>
          <classpath>
             <pathelement path="${classpath}"/>
             <pathelement location=""/>
         </classpath>
     </java>
   </target>

    <target name="all" depends="repositoryjar,repositorywar">
    </target>

    <target name="release" depends="init,clean">
        <antcall target="repositorylib"/>
        <antcall target="clean"/>
        <antcall target="repositorysrcjar"/>
        <antcall target="repositoryjar"/>
        <antcall target="repositorytar"/>
        <antcall target="repositorywar"/>
        <antcall target="clientjar"/>
        <antcall target="idvplugin"/>
    </target>



     <target name="idvplugin" depends="init,clean">
        <property name="pluginclasspath" value="${libsdir}/idv.jar:${libsdir}/external.jar:${libsdir}/local-visad.jar:${libsdir}/visad.jar:${libsdir}/ncIdv.jar:${libsdir}/jython.jar:{libsdir}/doclint.jar:${libsdir}/j2h.jar:${libsdir}/repositorytds.jar:${libsdir}/repositorylib.jar:${libsdir}/servlet-api.jar"/>
        <javac
            verbose="false"
            classpath="${pluginclasspath}"
            debug="true"
            source="${srcversion}"
            deprecation="false" 
            destdir="${compiledir}"
            failonerror="${failonerror}" 
            nowarn="true"
            srcdir="${srcdir}"
            fork="true"
            memoryMaximumSize="256m"
           target="1.5"
        >
        <include name="ucar/unidata/repository/idv/RamaddaPublisher.java"/>
        <include name="ucar/unidata/repository/InteractiveRepositoryClient.java"/>
        </javac>
        <jar 
            basedir="${compiledir}"
            update="false"
            compress="true"
            jarfile="${jars_dest}/ramaddaplugin.jar">
            <include name="ucar/unidata/repository/**/*.class"/> 
            <include name="ucar/unidata/repository/idv/publishertypes.xml"/>
            <include name="ucar/unidata/repository/idv/publishers.xml"/>
            <include name="ucar/unidata/repository/htdocs/icons/folderopen.png"/>
            <include name="ucar/unidata/repository/htdocs/icons/folderclosed.png"/>
	    </jar>

        <copy overwrite="true"  todir="${user.home}/.unidata/idv/DefaultIdv/plugins">
             <fileset file="${jars_dest}/ramaddaplugin.jar"/>
        </copy>


    </target>







    <target name="workshopplugin" depends="init,clean">
        <property name="pluginclasspath" value="${libsdir}/idv.jar:${libsdir}/external.jar:${libsdir}/local-visad.jar:${libsdir}/visad.jar:${libsdir}/ncIdv.jar:${libsdir}/jython.jar:{libsdir}/doclint.jar:${libsdir}/j2h.jar:${libsdir}/repositorytds.jar:${libsdir}/repositorylib.jar:${libsdir}/servlet-api.jar"/>
        <javac
            verbose="false"
            classpath="${pluginclasspath}"
            debug="true"
            source="${srcversion}"
            deprecation="false" 
            destdir="${compiledir}"
            failonerror="${failonerror}" 
            nowarn="true"
            srcdir="${srcdir}"
            fork="true"
            memoryMaximumSize="256m"
           target="1.5"
        >
        <include name="ucar/unidata/repository/idv/RamaddaPublisher.java"/>
        </javac>
        <jar 
            basedir="${compiledir}"
            update="false"
            compress="true"
            jarfile="${jars_dest}/usersworkshop.jar">
            <include name="ucar/unidata/repository/**/*.class"/> 
            <include name="ucar/unidata/repository/idv/workshop.properties"/>
            <include name="ucar/unidata/repository/idv/workshoplogo.jpg"/>
            <include name="ucar/unidata/repository/idv/publishertypes.xml"/>
            <include name="ucar/unidata/repository/idv/workshoppublishers.xml"/>
            <include name="ucar/unidata/repository/htdocs/icons/folderopen.png"/>
            <include name="ucar/unidata/repository/htdocs/icons/folderclosed.png"/>
	    </jar>

        <copy overwrite="true"  todir="${user.home}/.unidata/idv/DefaultIdv/plugins">
             <fileset file="${jars_dest}/usersworkshop.jar"/>
        </copy>


    </target>



    <target name="clientjar" depends="init,clean">
        <property name="xclasspath" value="${libsrc}/commons-httpclient-3.1.jar:${libsdir}/extra.jar:${srcdir}"/>
        <javac
            verbose="false"
            classpath="${xclasspath}"
            debug="true"
            source="${srcversion}"
            deprecation="false" 
            destdir="${compiledir}"
            failonerror="${failonerror}" 
            nowarn="true"
            srcdir="${srcdir}"
            fork="true"
            memoryMaximumSize="512m"
           target="1.5"
        >
        <include name="ucar/unidata/repository/client/InteractiveRepositoryClient.java"/>
        <include name="ucar/unidata/repository/InteractiveRepositoryClient.java"/>
        </javac>
        <mkdir dir="${tmpjardir}"/>
        <delete includeemptydirs="true">
            <fileset dir="${tmpjardir}" includes="**/*"/>
        </delete>
        <unjar src="${jars_dest}/extra.jar" dest="${tmpjardir}"/>

        <jar 
            basedir="${compiledir}"
            update="false"
            compress="true"
            jarfile="${jars_dest}/repositoryclient.jar">
           <manifest>
              <attribute name="Implementation-Title" value="Unidata's Ramada Client"/>
              <attribute name="Implementation-Version" value="1.0"/>
              <attribute name="Implementation-Vendor" value="UCAR/Unidata"/>
              <attribute name="Main-class" value="ucar.unidata.repository.RepositoryClient"/>
              <attribute name="Class-Path" value="commons-httpclient-3.1.jar commons-logging-1.1.jar commons-codec-1.3.jar"/>
            </manifest> 


            <include name="lib/tmpjardir/org/apache/xerces/impl/dv/util/Base64.class"/>

            <include name="ucar/**/*.class"/>
            <include name="ucar/unidata/repository/htdocs/icons/folderopen.png"/>
            <include name="ucar/unidata/repository/htdocs/icons/folderclosed.png"/>

	    </jar>


        <zip destfile="${libsdir}/repositoryclient.zip">
         <zipfileset dir="${libsdir}" includes="repositoryclient.jar" fullpath="repositoryclient/repositoryclient.jar"/>
         <zipfileset dir="${libsrc}" includes="commons-httpclient-3.1.jar" fullpath="repositoryclient/commons-httpclient-3.1.jar"/>
         <zipfileset dir="${libsrc}" includes="commons-logging-1.1.jar" fullpath="repositoryclient/commons-logging-1.1.jar"/>
         <zipfileset dir="${libsrc}" includes="commons-codec-1.3.jar" fullpath="repositoryclient/commons-codec-1.3.jar"/>
         <zipfileset dir="ucar/unidata/repository/release" includes="README.CLIENT" fullpath="repositoryclient/README"/>
        </zip>

    </target>


    <target name="compile" depends="init,clean,jc"/>


    <target name="jc" depends="init">
        <javac
            classpath="${classpath}"
            debug="true"
            source="${srcversion}"
            deprecation="false" 
            destdir="${compiledir}"
            failonerror="${failonerror}" 
            nowarn="true"
            srcdir="${srcdir}"
	    fork="true"
            memoryMaximumSize="512m"
           target="1.5"
        >
        <include name="ucar/unidata/repository/*.java"/>
        <include name="ucar/unidata/repository/client/*.java"/>
        <include name="ucar/unidata/repository/output/*.java"/>
        <include name="ucar/unidata/repository/data/*.java"/>
        <include name="ucar/unidata/repository/metadata/*.java"/>
        <include name="ucar/unidata/repository/harvester/*.java"/>
        <include name="ucar/unidata/repository/collab/*.java"/>
        <include name="ucar/unidata/repository/type/*.java"/>
        <include name="ucar/unidata/repository/ftp/*.java"/>
        <include name="ucar/unidata/repository/util/*.java"/>
        <include name="ucar/unidata/repository/monitor/*.java"/>
        <include name="ucar/unidata/repository/idv/*.java"/>

<!--
        <include name="ucar/unidata/repository/idv/IdvWebstartOutputHandler.java"/>
-->
        <include name="ucar/unidata/repository/idv/TdsOutputHandler.java"/>
        </javac>
    </target>

    <target name="repositoryjar" depends="compile">
        <copy overwrite="true" file="ucar/unidata/repository/resources/version.properties" tofile="ucar/unidata/repository/resources/build.properties">
            <filterset>
                <filter token="DATE" value="${date}"/>
                <filter token="VERSION" value="${version}"/>
            </filterset>
        </copy>
        <jar 
            basedir="${srcdir}"
            compress="true"
            update="false"
            jarfile="${jars_dest}/repository.jar">
           <manifest>
              <attribute name="Implementation-Title" value="Unidata's Ramada"/>
              <attribute name="Implementation-Version" value="1.0"/>
              <attribute name="Implementation-Vendor" value="UCAR/Unidata"/>
              <attribute name="Main-class" value="ucar.unidata.repository.RepositoryServer"/>
              <attribute name="Class-Path" value="idv.jar repositorylib.jar  repositorytds.jar servlet-api.jar"/>
            </manifest> 
            <include name="ucar/**/*.class"/>
            <include name="ucar/unidata/repository/htdocs/**/*.*"/>
            <include name="ucar/unidata/repository/docs/userguide/processed/**/*.*"/>
            <include name="ucar/unidata/repository/resources/**/*.*"/>
            <include name="ucar/unidata/repository/idv/template.jnlp"/>
            <include name="auxdata/maps/*"/>
            <include name="auxdata/ui/icons/*"/>
        </jar>
    </target>


    <target name="zip" depends="init">
        <zip destfile="${libsdir}/repository.zip">
          <zipfileset dir="${releasedir}" prefix="repository"/>
        </zip>
     </target>

    <target name="repositorytar" depends="init">
        <mkdir dir="${releasedir}"/>
        <delete includeemptydirs="true">
            <fileset dir="${releasedir}" includes="**/*"/>
        </delete>
        <copy  file="${libsdir}/repository.jar" todir="${releasedir}"/>
        <copy  file="${libsdir}/idv.jar" todir="${releasedir}"/>
        <copy  file="${libsdir}/repositorylib.jar" todir="${releasedir}"/>
        <copy  file="${repositorydir}/release/ramadda.sh" todir="${releasedir}"/>
        <copy  file="${repositorydir}/release/ramadda.bat" todir="${releasedir}"/>
        <copy  file="${repositorydir}/release/ramaddamysql.sh" todir="${releasedir}"/>
        <copy  file="${repositorydir}/README" todir="${releasedir}"/>
        <copy  file="${libsdir}/repositorytds.jar" todir="${releasedir}"/>
        <copy  file="${libsdir}/servlet-api.jar" todir="${releasedir}"/>
        <delete file="${libsdir}/repository.tar"/>
        <delete file="${libsdir}/repository.zip"/>
        <zip destfile="${libsdir}/repository.zip">
          <zipfileset dir="${releasedir}" prefix="repository"/>
        </zip>


<!--
        <tar 
            destfile="${libsdir}/repository.tar">
          <tarfileset dir="${releasedir}"
              prefix="repository">
              <include name="*"/>
         </tarfileset>

        </tar>

-->


<!--
        <delete includeemptydirs="true">
            <fileset dir="${releasedir}" includes="**/*"/>
        </delete>
-->
    </target>


    <target name="war" depends="repositorywar">
    </target>


    <target name="repositorywar" depends="init">
      <delete>
           <fileset file="${libsdir}/repository.war"/>
       </delete>
      <war webxml="${repositorydir}/release/web.xml" destfile="${libsdir}/repository.war">
          <webinf file="${repositorydir}/release/repository.properties"/>
          <lib file="${libsdir}/repository.jar"/>
          <lib file="${libsdir}/idv.jar"/>
          <lib file="${libsdir}/repositorylib.jar"/>
          <lib file="${libsdir}/repositorytds.jar"/>
      </war>


    </target>


    <target name="repositorylib" depends="init">
        <mkdir dir="${tmpjardir}"/>
        <delete includeemptydirs="true">
            <fileset dir="${tmpjardir}" includes="**/*"/>
        </delete>
        <unjar src="${jars_dest}/visad.jar" dest="${tmpjardir}"/>
        <unjar src="${jars_dest}/local-visad.jar" dest="${tmpjardir}"/>
        <unjar src="${libsdir}/extra.jar" dest="${tmpjardir}"/>
        <unjar src="${libsdir}/jython.jar" dest="${tmpjardir}"/>
        <unjar src="${libsdir}/external.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/twitter4j-1.1.4.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/jetty.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/jetty-util.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/mailapi.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/javadiff.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/smtp.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/postgres.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/mysql.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/derby.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/derbytools.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/commons-io-1.4.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/commons-dbcp-1.2.2.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/commons-pool-1.5.3.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/commons-fileupload-1.2.1.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/jfreechart.jar" dest="${tmpjardir}"/>

        <unjar src="${libsrc}/ftplet-api-1.0.3.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/ftpserver-core-1.0.3.jar" dest="${tmpjardir}"/>
        <unjar src="${libsrc}/mina-core-2.0.0-M6.jar" dest="${tmpjardir}"/>
<!--        <unjar src="${libsrc}/slf4j-api-1.5.2.jar" dest="${tmpjardir}"/>
-->






<!--
        <unjar src="${libsdir}/servlet-api.jar" dest="${tmpjardir}"/>
-->



        <jar 
            basedir="${tmpjardir}"
            update="false"
            compress="true"
            jarfile="${libsdir}/repositorylib.jar">
              <include name="**"/>
<!--
              <exclude name="ucar/netcdf/**"/>
-->
              <exclude name="ucar/multiarray/**"/>
        </jar>

        <delete dir="${tmpjardir}"/>
    </target>



    <target name="repositorysrcjar" depends="init">
        <jar 
            update="false"
            basedir="${compiledir}"
            compress="true"
            jarfile="${libsdir}/repository_src.jar">
            <include name="ucar/**"/>
            <include name="lib/repositorylib.jar"/>
            <include name="lib/repositorytds.jar"/>
            <include name="lib/servlet-api.jar"/>
            <exclude name="ucar/**/CVS/**"/>
            <exclude name="ucar/**/*.class"/>
            <exclude name="ucar/**/*.map"/>
            <exclude name="ucar/**/*.jar"/>            
            <exclude name="ucar/**/*.ascii"/>            
            <exclude name="ucar/**/*.tml"/>            
            <exclude name="ucar/**/*.bak"/>            
            <exclude name="ucar/**/*.zip"/>            
            <exclude name="ucar/**/*.shp"/>            
            <exclude name="ucar/**/*.nc"/>            
            <exclude name="ucar/unidata/data/storm/*ADOT*"/>
            <exclude name="ucar/unidata/idv/control/storm/*ADOT*"/>
            <exclude name="ucar/unidata/idv/control/storm/StormIntensityControl.java"/>
            <exclude name="ucar/unidata/apps/demo/**"/>
            <exclude name="ucar/unidata/apps/imageviewer/**"/>
            <exclude name="ucar/unidata/apps/geon/**"/>
            <exclude name="ucar/unidata/apps/lead/**"/>
            <exclude name="ucar/unidata/apps/rico/**"/>
            <exclude name="ucar/unidata/apps/sti/**"/>
            <exclude name="ucar/unidata/apps/trex/**"/>
            <exclude name="ucar/unidata/apps/workshop/**"/>
            <exclude name="ucar/unidata/gridviewer/**/*.*"/>
            <exclude name="ucar/unidata/grid/**"/>
            <exclude name="ucar/unidata/geoloc/**"/>
            <exclude name="ucar/unidata/idv/release/**"/>
            <exclude name="ucar/unidata/view/sounding/test/**"/>


<!--
            <exclude name="ucar/unidata/gis/**"/>
            <exclude name="ucar/unidata/repository/docs/**"/>
            <exclude name="ucar/unidata/ui/symbol/**"/>
	    <exclude name="ucar/unidata/idv/**"/>
            <exclude name="ucar/unidata/apps/**"/>
            <exclude name="ucar/unidata/gridviewer/**/*.*"/>
            <exclude name="ucar/visad/**"/>
            <exclude name="ucar/visad/physics/**"/>
            <exclude name="ucar/visad/functiontypes/**"/>
            <exclude name="ucar/visad/display/**"/>
            <exclude name="ucar/unidata/view/sounding/**"/>
            <exclude name="ucar/unidata/grid/**"/>
            <exclude name="ucar/unidata/geoloc/**"/>
            <exclude name="ucar/unidata/view/sounding/test/**"/>
-->

        </jar>
    </target>


    <target name="javadoc" depends="init">
        <javadoc
            Author="true"
            Doctitle="Unidata RAMADDA"
            Use="true"
            Version="true"
            Windowtitle="Unidata RAMADDA"
            classpath="${classpath}:/upc/share/junit/junit.jar"
            destdir="${docs_javadoc_dest}"
            maxmemory="256m"
            sourcepath="${srcdir}">
            <link href="http://java.sun.com/j2se/1.5.0/docs/api"/>
            <package name="ucar.unidata.repository.*"/>
            <package name="ucar.unidata.sql"/>
        </javadoc>
    </target>



</project>
